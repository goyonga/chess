<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شطرنج آنلاین مدرن</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chess Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --board-bg: #262421;
            --light-square: #f0d9b5;
            --dark-square: #b58863;
            --highlight-last: rgba(204, 212, 53, 0.5);
            --highlight-possible: rgba(30, 150, 40, 0.3);
            --highlight-check: rgba(255, 0, 0, 0.4);
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #1a1a1a;
            color: #e2e8f0;
        }
        .chessboard-container {
            width: 95vw;
            max-width: 80vh;
        }
        .white-1e1d7 { background-color: var(--light-square) !important; color: var(--dark-square) !important; }
        .black-3c85d { background-color: var(--dark-square) !important; color: var(--light-square) !important; }
        .highlight-last .square-55d63 { box-shadow: inset 0 0 0 4px var(--highlight-last); }
        .highlight-check .square-55d63 { background-color: var(--highlight-check) !important; }
        .highlight-possible .square-55d63::after {
            content: ''; display: block; width: 30%; height: 30%; border-radius: 50%;
            background: var(--highlight-possible); position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-pulse { animation: pulse-bg 2s infinite; }
        @keyframes pulse-bg { 0%, 100% { background-color: #3b82f6; } 50% { background-color: #1d4ed8; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-7xl mx-auto p-4">

        <!-- Username Screen -->
        <div id="username-screen" class="text-center fade-in">
            <h1 class="text-5xl font-bold mb-4 text-white">شطرنج آنلاین</h1>
            <p class="text-gray-400 mb-8">برای ورود به لابی، یک نام کاربری انتخاب کنید.</p>
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm mx-auto">
                <input type="text" id="username-input" class="text-center bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" placeholder="نام کاربری شما">
                <button id="save-username-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-chess-knight mr-2"></i> ورود به لابی
                </button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold text-white">لابی بازی</h1>
                <div class="text-right">
                    <div class="text-lg">خوش آمدی, <span id="username-display" class="font-bold text-indigo-400"></span>!</div>
                    <button id="change-username-btn" class="text-sm text-gray-500 hover:text-indigo-400">تغییر نام</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Create Game -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">بازی جدید بساز</h2>
                    <label for="time-control" class="block mb-2 text-sm font-medium text-gray-300">زمان بازی (دقیقه):</label>
                    <select id="time-control" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                        <option value="1">۱ دقیقه (بلیتز)</option>
                        <option value="3">۳ دقیقه (بلیتز)</option>
                        <option value="5" selected>۵ دقیقه (بلیتز)</option>
                        <option value="10">۱۰ دقیقه (رپید)</option>
                        <option value="15">۱۵ دقیقه (رپید)</option>
                    </select>
                    <button id="create-game-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        <i class="fas fa-plus-circle mr-2"></i> ساخت بازی
                    </button>
                </div>
                <!-- Open Games -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl md:col-span-2">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">به یک بازی ملحق شو</h2>
                    <div id="open-games-list" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        <!-- Games will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden fade-in">
            <div class="flex flex-col lg:flex-row gap-4 justify-center">
                <!-- Player Info & Board -->
                <div class="flex-grow flex flex-col items-center">
                    <!-- Opponent Info -->
                    <div id="opponent-info" class="w-full max-w-xl p-3 bg-gray-800 rounded-lg shadow-lg flex justify-between items-center mb-2"></div>
                    <!-- Board -->
                    <div class="chessboard-container shadow-2xl rounded-lg overflow-hidden">
                        <div id="board" class="w-full"></div>
                    </div>
                    <!-- Player Info -->
                    <div id="player-info" class="w-full max-w-xl p-3 bg-gray-800 rounded-lg shadow-lg flex justify-between items-center mt-2"></div>
                </div>

                <!-- Side Panel -->
                <div class="w-full lg:w-80 bg-gray-800 rounded-xl shadow-2xl p-4 flex flex-col flex-shrink-0">
                    <div id="game-status" class="w-full text-center mb-3 p-3 bg-gray-700 rounded-lg font-bold text-lg"></div>
                    <!-- Moves History -->
                    <div class="flex-grow bg-gray-900 rounded-lg p-2 mb-3 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-2 text-center">تاریخچه حرکات</h3>
                        <div id="pgn-display" class="text-sm space-y-1 text-center font-mono"></div>
                    </div>
                    <!-- Chat -->
                    <div class="flex-grow bg-gray-900 rounded-lg p-2 mb-3 flex flex-col">
                         <h3 class="text-lg font-semibold mb-2 text-center">چت</h3>
                         <div id="chat-box" class="flex-grow space-y-2 overflow-y-auto mb-2 pr-2"></div>
                         <div class="flex gap-2">
                             <input type="text" id="chat-input" class="flex-grow bg-gray-700 border border-gray-600 rounded-md p-2 text-sm" placeholder="پیام خود را بنویسید...">
                             <button id="send-chat-btn" class="bg-indigo-600 hover:bg-indigo-700 rounded-md px-4"><i class="fas fa-paper-plane"></i></button>
                         </div>
                    </div>
                    <!-- Controls -->
                    <div class="grid grid-cols-2 gap-2">
                        <button id="resign-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-flag mr-2"></i>تسلیم</button>
                        <button id="copy-game-id-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-copy mr-2"></i>کپی لینک</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-95">
            <h2 id="game-over-title" class="text-4xl font-bold mb-4"></h2>
            <p id="game-over-message" class="text-lg mb-6"></p>
            <div class="flex gap-4">
                <button id="rematch-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">بازی مجدد</button>
                <button id="back-to-lobby-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">بازگشت به لابی</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-700 text-white py-3 px-6 rounded-xl shadow-lg opacity-0 pointer-events-none transition-all duration-300 z-[100]"></div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, query, where, getDocs, serverTimestamp, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chess-app';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const screens = {
            username: document.getElementById('username-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen'),
        };
        const usernameInput = document.getElementById('username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const changeUsernameBtn = document.getElementById('change-username-btn');
        const usernameDisplay = document.getElementById('username-display');
        const createGameBtn = document.getElementById('create-game-btn');
        const openGamesList = document.getElementById('open-games-list');
        const boardEl = document.getElementById('board');
        const pgnDisplay = document.getElementById('pgn-display');
        const gameStatus = document.getElementById('game-status');
        const playerInfoEl = document.getElementById('player-info');
        const opponentInfoEl = document.getElementById('opponent-info');
        const resignBtn = document.getElementById('resign-btn');
        const copyGameIdBtn = document.getElementById('copy-game-id-btn');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverMessage = document.getElementById('game-over-message');
        const rematchBtn = document.getElementById('rematch-btn');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const toastEl = document.getElementById('toast-notification');

        // --- Game State Variables ---
        let board = null;
        let game = new Chess();
        let currentUser = null;
        let currentUsername = null;
        let currentGameId = null;
        let playerColor = null;
        let gameUnsubscribe = null;
        let lobbyUnsubscribe = null;
        let timerInterval = null;
        let toastTimeout;

        // --- Sound Effects ---
        const sounds = {
            move: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 } }).toDestination(),
            capture: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.0, release: 0.2 } }).toDestination(),
            check: new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 } }).toDestination(),
            gameEnd: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.5 } }).toDestination()
        };
        
        // --- Utility Functions ---
        const showScreen = (screenName) => {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        };

        const showToast = (message) => {
            clearTimeout(toastTimeout);
            toastEl.textContent = message;
            toastEl.classList.remove('opacity-0');
            toastTimeout = setTimeout(() => toastEl.classList.add('opacity-0'), 3000);
        };

        const formatTime = (seconds) => {
            if (seconds < 0) seconds = 0;
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        // --- Firebase References ---
        const getGameRef = (gameId) => doc(db, `artifacts/${appId}/public/data/games`, gameId);
        const getUserRef = (userId) => doc(db, `artifacts/${appId}/public/data/users`, userId);
        const gamesColRef = collection(db, `artifacts/${appId}/public/data/games`);
        
        // --- App Initialization ---
        const initApp = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showToast("خطا در اتصال به سرور. لطفا دوباره تلاش کنید.");
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const userDoc = await getDoc(getUserRef(user.uid));
                    if (userDoc.exists() && userDoc.data().username) {
                        currentUsername = userDoc.data().username;
                        showLobby();
                    } else {
                        showScreen('username');
                    }
                } else {
                    showScreen('username');
                }
            });
        };

        // --- Screen & UI Logic ---
        saveUsernameBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (username.length < 3) {
                showToast("نام کاربری باید حداقل ۳ حرف باشد.");
                return;
            }
            currentUsername = username;
            await setDoc(getUserRef(currentUser.uid), { username: username, wins: 0, losses: 0, draws: 0 }, { merge: true });
            showLobby();
        });

        changeUsernameBtn.addEventListener('click', () => showScreen('username'));

        const showLobby = () => {
            showScreen('lobby');
            usernameDisplay.textContent = currentUsername;
            if (gameUnsubscribe) gameUnsubscribe();
            if (timerInterval) clearInterval(timerInterval);
            currentGameId = null;
            listenForOpenGames();
        };

        // --- Lobby Logic ---
        const listenForOpenGames = () => {
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            const q = query(gamesColRef, where("status", "==", "waiting"));
            lobbyUnsubscribe = onSnapshot(q, (snapshot) => {
                openGamesList.innerHTML = '';
                if (snapshot.empty) {
                    openGamesList.innerHTML = '<p class="text-gray-500 text-center">هیچ بازی منتظر حریف نیست. یکی بسازید!</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const gameData = doc.data();
                    const gameEl = document.createElement('div');
                    gameEl.className = "bg-gray-700 p-3 rounded-lg flex justify-between items-center";
                    gameEl.innerHTML = `
                        <div>
                            <p class="font-bold">${gameData.players.p1.username}</p>
                            <p class="text-sm text-gray-400">${gameData.timeControl / 60} دقیقه</p>
                        </div>
                        <button class="join-game-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" data-id="${doc.id}">ملحق شو</button>
                    `;
                    openGamesList.appendChild(gameEl);
                });
            });
        };

        createGameBtn.addEventListener('click', async () => {
            const timeControl = parseInt(document.getElementById('time-control').value) * 60;
            const newGameId = `game-${crypto.randomUUID().substring(0, 8)}`;
            const gameData = {
                fen: "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
                status: 'waiting', // waiting, inprogress, mate, draw, timeout, resign
                turn: 'w',
                players: {
                    p1: { userId: currentUser.uid, username: currentUsername, color: null },
                    p2: null
                },
                timeControl: timeControl,
                timers: { p1: timeControl, p2: timeControl },
                lastMoveTimestamp: serverTimestamp(),
                winner: null,
                chat: [],
                pgn: "",
                rematchOffer: null,
                createdAt: serverTimestamp()
            };
            await setDoc(getGameRef(newGameId), gameData);
            await setupGame(newGameId);
        });

        document.addEventListener('click', e => {
            if (e.target && e.target.classList.contains('join-game-btn')) {
                const gameId = e.target.getAttribute('data-id');
                joinGame(gameId);
            }
        });

        const joinGame = async (gameId) => {
            const gameRef = getGameRef(gameId);
            const gameDoc = await getDoc(gameRef);
            if (!gameDoc.exists()) return showToast("این بازی دیگر موجود نیست.");
            
            const gameData = gameDoc.data();
            if (gameData.players.p2) return showToast("این بازی پر است.");

            const colorAssignment = Math.random() < 0.5 ? ['w', 'b'] : ['b', 'w'];
            
            await updateDoc(gameRef, {
                status: 'inprogress',
                'players.p1.color': colorAssignment[0],
                'players.p2': { userId: currentUser.uid, username: currentUsername, color: colorAssignment[1] },
                lastMoveTimestamp: serverTimestamp()
            });
            await setupGame(gameId);
        };

        // --- Game Setup ---
        const setupGame = async (gameId) => {
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            currentGameId = gameId;
            showScreen('game');

            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(getGameRef(gameId), (doc) => {
                if (!doc.exists()) {
                    showToast("بازی حذف شده یا به پایان رسیده است.");
                    showLobby();
                    return;
                }
                handleGameStateUpdate(doc.data());
            });
        };

        // --- Game State Handling ---
        const handleGameStateUpdate = (gameData) => {
            // Determine player and opponent
            const amIPlayer1 = gameData.players.p1.userId === currentUser.uid;
            const player = amIPlayer1 ? gameData.players.p1 : gameData.players.p2;
            const opponent = amIPlayer1 ? gameData.players.p2 : gameData.players.p1;
            playerColor = player?.color;
            
            // Load game state
            const isNewFen = game.fen() !== gameData.fen;
            if (isNewFen) {
                game.load(gameData.fen);
                highlightLastMove();
                playMoveSound(gameData.pgn);
            }
            
            // Initialize or update board
            if (!board) {
                board = Chessboard('board', {
                    draggable: true,
                    position: game.fen(),
                    orientation: playerColor === 'w' ? 'white' : 'black',
                    onDragStart: onDragStart,
                    onDrop: onDrop,
                    pieceTheme: 'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/img/chesspieces/wikipedia/{piece}.png'
                });
                $(window).resize(board.resize);
            } else {
                if (board.orientation() !== (playerColor === 'w' ? 'white' : 'black')) {
                    board.orientation(playerColor === 'w' ? 'white' : 'black');
                }
                board.position(game.fen());
            }

            // Update UI elements
            updatePlayerInfo(playerInfoEl, player, amIPlayer1 ? gameData.timers.p1 : gameData.timers.p2);
            updatePlayerInfo(opponentInfoEl, opponent, amIPlayer1 ? gameData.timers.p2 : gameData.timers.p1, true);
            updateStatus(gameData, playerColor);
            updatePgn(gameData.pgn);
            updateChat(gameData.chat);
            updateTimers(gameData);

            // Handle game over
            if (gameData.status !== 'inprogress' && gameData.status !== 'waiting') {
                showGameOverModal(gameData, player);
            } else {
                hideGameOverModal();
            }
        };

        // --- UI Update Functions ---
        const updatePlayerInfo = (el, player, time, isOpponent = false) => {
            if (!player) {
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-clock text-4xl text-gray-500"></i>
                        <div>
                            <h3 class="font-bold text-lg">در انتظار حریف...</h3>
                        </div>
                    </div>
                `;
                return;
            }
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-user-circle text-4xl ${isOpponent ? 'text-gray-400' : 'text-green-400'}"></i>
                    <div>
                        <h3 class="font-bold text-lg truncate">${player.username}</h3>
                        <div class="text-sm text-gray-400">
                            <i class="fas fa-chess-${player.color === 'w' ? 'pawn' : 'chess-pawn'}" style="color: ${player.color === 'w' ? '#fff' : '#000'}"></i>
                            ${player.color === 'w' ? 'سفید' : 'سیاه'}
                        </div>
                    </div>
                </div>
                <div class="font-mono text-3xl font-bold text-white">${formatTime(time)}</div>
            `;
        };

        const updateStatus = (gameData, myColor) => {
            let statusText = '';
            let isMyTurn = gameData.turn === myColor;
            gameStatus.classList.remove('status-pulse', 'bg-red-700', 'bg-green-700');

            switch(gameData.status) {
                case 'waiting': statusText = 'در انتظار حریف...'; break;
                case 'inprogress':
                    statusText = `نوبت ${gameData.turn === 'w' ? 'سفید' : 'سیاه'}`;
                    if (game.in_check()) statusText += ' - کیش!';
                    gameStatus.classList.add(isMyTurn ? 'bg-green-700' : 'bg-gray-700');
                    if(isMyTurn) gameStatus.classList.add('status-pulse');
                    break;
                case 'mate': statusText = `مات! ${gameData.winner.username} برنده شد.`; gameStatus.classList.add('bg-red-700'); break;
                case 'draw': statusText = 'بازی مساوی شد.'; gameStatus.classList.add('bg-gray-600'); break;
                case 'timeout': statusText = `پایان زمان! ${gameData.winner.username} برنده شد.`; gameStatus.classList.add('bg-red-700'); break;
                case 'resign': statusText = `${gameData.winner.username} با تسلیم حریف برنده شد.`; gameStatus.classList.add('bg-red-700'); break;
            }
            gameStatus.textContent = statusText;
        };

        const updatePgn = (pgn) => {
            const history = game.history({ verbose: true });
            pgnDisplay.innerHTML = history.map((move, i) => {
                if (i % 2 === 0) {
                    return `<div class="grid grid-cols-3 gap-2"><span>${Math.floor(i / 2) + 1}.</span> <span>${move.san}</span>`;
                } else {
                    return `<span>${move.san}</span></div>`;
                }
            }).join('');
            pgnDisplay.scrollTop = pgnDisplay.scrollHeight;
        };
        
        const updateChat = (chat) => {
            chatBox.innerHTML = chat.map(msg => `
                <div class="text-sm">
                    <span class="font-bold ${msg.userId === currentUser.uid ? 'text-indigo-400' : 'text-gray-400'}">${msg.username}:</span>
                    <span class="text-gray-200">${msg.message}</span>
                </div>
            `).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const updateTimers = (gameData) => {
            clearInterval(timerInterval);
            if (gameData.status !== 'inprogress') return;

            timerInterval = setInterval(async () => {
                const now = Date.now();
                const lastMoveTime = gameData.lastMoveTimestamp?.toDate().getTime() || now;
                const elapsed = (now - lastMoveTime) / 1000;

                const amIPlayer1 = gameData.players.p1.userId === currentUser.uid;
                const turnPlayer = gameData.turn === gameData.players.p1.color ? 'p1' : 'p2';
                
                let p1Time = gameData.timers.p1;
                let p2Time = gameData.timers.p2;

                if (turnPlayer === 'p1') p1Time -= elapsed;
                else p2Time -= elapsed;

                updatePlayerInfo(playerInfoEl, amIPlayer1 ? gameData.players.p1 : gameData.players.p2, amIPlayer1 ? p1Time : p2Time);
                updatePlayerInfo(opponentInfoEl, amIPlayer1 ? gameData.players.p2 : gameData.players.p1, amIPlayer1 ? p2Time : p1Time, true);
                
                // Timeout check (only one player should do this)
                if ((p1Time <= 0 || p2Time <= 0) && amIPlayer1) {
                    clearInterval(timerInterval);
                    const loser = p1Time <= 0 ? gameData.players.p1 : gameData.players.p2;
                    const winner = p1Time <= 0 ? gameData.players.p2 : gameData.players.p1;
                    if (winner && loser) {
                       await endGame(gameData, 'timeout', winner, loser);
                    }
                }
            }, 1000);
        };

        // --- Game Logic ---
        const onDragStart = (source, piece) => {
            return !game.game_over() &&
                   game.turn() === playerColor &&
                   piece.startsWith(playerColor);
        };

        const onDrop = async (source, target) => {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            const gameRef = getGameRef(currentGameId);
            const gameDoc = await getDoc(gameRef);
            const gameData = gameDoc.data();
            
            const now = Date.now();
            const lastMoveTime = gameData.lastMoveTimestamp?.toDate().getTime() || now;
            const timeSpent = (now - lastMoveTime) / 1000;
            
            const amIPlayer1 = gameData.players.p1.userId === currentUser.uid;
            const myTimerKey = amIPlayer1 ? 'timers.p1' : 'timers.p2';
            
            const updates = {
                fen: game.fen(),
                pgn: game.pgn(),
                turn: game.turn(),
                lastMoveTimestamp: serverTimestamp(),
                [myTimerKey]: gameData.timers[amIPlayer1 ? 'p1' : 'p2'] - timeSpent
            };
            
            if (game.game_over()) {
                const winnerPlayer = game.turn() === 'b' ? 
                    (gameData.players.p1.color === 'w' ? gameData.players.p1 : gameData.players.p2) : 
                    (gameData.players.p1.color === 'b' ? gameData.players.p1 : gameData.players.p2);
                const loserPlayer = game.turn() === 'b' ? 
                    (gameData.players.p1.color === 'b' ? gameData.players.p1 : gameData.players.p2) : 
                    (gameData.players.p1.color === 'w' ? gameData.players.p1 : gameData.players.p2);
                
                if (game.in_checkmate()) {
                    await endGame(gameData, 'mate', winnerPlayer, loserPlayer, updates);
                } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
                    await endGame(gameData, 'draw', null, null, updates);
                }
            } else {
                await updateDoc(gameRef, updates);
            }
        };

        const endGame = async (gameData, reason, winner, loser, moveUpdates = {}) => {
            clearInterval(timerInterval);
            const finalUpdates = {
                ...moveUpdates,
                status: reason,
                winner: winner || null,
            };

            const batch = writeBatch(db);
            batch.update(getGameRef(currentGameId), finalUpdates);

            if (reason === 'mate' || reason === 'timeout' || reason === 'resign') {
                batch.update(getUserRef(winner.userId), { wins: increment(1) });
                batch.update(getUserRef(loser.userId), { losses: increment(1) });
            } else if (reason === 'draw') {
                batch.update(getUserRef(gameData.players.p1.userId), { draws: increment(1) });
                if (gameData.players.p2) {
                    batch.update(getUserRef(gameData.players.p2.userId), { draws: increment(1) });
                }
            }
            await batch.commit();
        };

        const highlightLastMove = () => {
            document.querySelectorAll('.highlight-last').forEach(el => el.classList.remove('highlight-last'));
            document.querySelectorAll('.highlight-check').forEach(el => el.classList.remove('highlight-check'));
            
            const history = game.history({ verbose: true });
            if (history.length > 0) {
                const lastMove = history[history.length - 1];
                document.querySelector(`.square-${lastMove.from}`).parentElement.classList.add('highlight-last');
                document.querySelector(`.square-${lastMove.to}`).parentElement.classList.add('highlight-last');
            }
            if (game.in_check()) {
                const kingPos = findKing(game.turn());
                if(kingPos) document.querySelector(`.square-${kingPos}`).parentElement.classList.add('highlight-check');
            }
        };
        
        const findKing = (color) => {
            const boardState = game.board();
            for(let i = 0; i < 8; i++) {
                for(let j = 0; j < 8; j++) {
                    const square = boardState[i][j];
                    if(square && square.type === 'k' && square.color === color) {
                        return square.square;
                    }
                }
            }
            return null;
        };

        const playMoveSound = (pgn) => {
            if (!pgn) return;
            if (pgn.includes('#')) {
                sounds.gameEnd.triggerAttackRelease("C4", "0.5s");
            } else if (pgn.includes('+')) {
                sounds.check.triggerAttackRelease("G#4", "0.3s");
            } else if (pgn.includes('x')) {
                sounds.capture.triggerAttackRelease("C3", "0.2s");
            } else {
                sounds.move.triggerAttackRelease("C4", "0.1s");
            }
        };

        // --- Event Listeners ---
        resignBtn.addEventListener('click', async () => {
            if (confirm('آیا از تسلیم شدن مطمئن هستید؟')) {
                const gameDoc = await getDoc(getGameRef(currentGameId));
                const gameData = gameDoc.data();
                const amIPlayer1 = gameData.players.p1.userId === currentUser.uid;
                const winner = amIPlayer1 ? gameData.players.p2 : gameData.players.p1;
                const loser = amIPlayer1 ? gameData.players.p1 : gameData.players.p2;
                await endGame(gameData, 'resign', winner, loser);
            }
        });

        copyGameIdBtn.addEventListener('click', () => {
            const gameLink = `${window.location.origin}${window.location.pathname}?game=${currentGameId}`;
            navigator.clipboard.writeText(gameLink).then(() => {
                showToast('لینک بازی کپی شد!');
            }).catch(() => showToast('خطا در کپی کردن لینک.'));
        });

        const sendChatMessage = async () => {
            const message = chatInput.value.trim();
            if (!message) return;
            
            const gameRef = getGameRef(currentGameId);
            const gameDoc = await getDoc(gameRef);
            const gameData = gameDoc.data();
            
            const newChat = [...gameData.chat, { userId: currentUser.uid, username: currentUsername, message }];
            await updateDoc(gameRef, { chat: newChat });
            chatInput.value = '';
        };
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

        // --- Modal Logic ---
        const showGameOverModal = (gameData, player) => {
            const isWinner = gameData.winner && gameData.winner.userId === player.userId;
            
            switch (gameData.status) {
                case 'mate':
                    gameOverTitle.textContent = isWinner ? 'پیروزی!' : 'شکست!';
                    gameOverMessage.textContent = `شما با مات کردن حریف برنده شدید.`;
                    if(!isWinner) gameOverMessage.textContent = `شما مات شدید!`;
                    break;
                case 'timeout':
                    gameOverTitle.textContent = isWinner ? 'پیروزی!' : 'شکست!';
                    gameOverMessage.textContent = `شما با تمام شدن زمان حریف برنده شدید.`;
                     if(!isWinner) gameOverMessage.textContent = `زمان شما به پایان رسید!`;
                    break;
                case 'resign':
                    gameOverTitle.textContent = isWinner ? 'پیروزی!' : 'شکست!';
                    gameOverMessage.textContent = `حریف شما تسلیم شد.`;
                     if(!isWinner) gameOverMessage.textContent = `شما تسلیم شدید.`;
                    break;
                case 'draw':
                    gameOverTitle.textContent = 'مساوی!';
                    gameOverMessage.textContent = 'بازی با نتیجه مساوی خاتمه یافت.';
                    break;
            }
            
            gameOverModal.classList.remove('opacity-0', 'pointer-events-none');
            gameOverModal.querySelector('.modal-content').classList.remove('scale-95');
        };

        const hideGameOverModal = () => {
            gameOverModal.classList.add('opacity-0', 'pointer-events-none');
            gameOverModal.querySelector('.modal-content').classList.add('scale-95');
        };

        backToLobbyBtn.addEventListener('click', () => {
            hideGameOverModal();
            showLobby();
        });
        
        rematchBtn.addEventListener('click', () => {
            // Rematch logic can be implemented here
            showToast("درخواست بازی مجدد ارسال شد (این قابلیت در حال توسعه است).");
            hideGameOverModal();
            showLobby();
        });


        // --- Start Application ---
        initApp();
    </script>
</body>
</html>
